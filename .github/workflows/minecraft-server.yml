name: Minecraft Server Runner

on:
  workflow_dispatch:
    inputs:
      server_name:
        description: 'ุงุณู ุงูุณูุฑูุฑ ุนูู Mega'
        required: true
        default: 'forge-1.20.1'
        type: choice
        options:
          - forge-1.20.1
          - fabric-1.16.5
          - vanilla-1.19.4
          - Custom (Type Below)
      
      custom_server_name:
        description: 'ุงุณู ุงูุณูุฑูุฑ ุงููุฎุตุต (ูู ุงุฎุชุฑุช Custom)'
        required: false
        default: ''
        type: string

jobs:
  run-minecraft-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 ุณุงุนุงุช
    
    steps:
      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install Dependencies
        run: |
          echo "๐ฆ ุชุซุจูุช ุงูุฃุฏูุงุช..."
          sudo apt-get update
          sudo apt-get install -y wget curl screen
          echo "โ ุชู ุชุซุจูุช ุงูุฃุฏูุงุช"
      
      - name: Install rclone
        run: |
          echo "๐ฆ ุชุซุจูุช rclone..."
          curl https://rclone.org/install.sh | sudo bash
          echo "โ ุชู ุชุซุจูุช rclone"
      
      - name: Configure rclone for Mega
        env:
          MEGA_EMAIL: ${{ secrets.MEGA_EMAIL }}
          MEGA_PASSWORD: ${{ secrets.MEGA_PASSWORD }}
        run: |
          echo "๐ ุฅุนุฏุงุฏ rclone ูู Mega..."
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf << EOF
          [mega]
          type = mega
          user = $MEGA_EMAIL
          pass = $(rclone obscure "$MEGA_PASSWORD")
          EOF
          echo "โ ุชู ุฅุนุฏุงุฏ rclone"
      
      - name: Download Server from Mega
        continue-on-error: true
        env:
          INPUT_SERVER_NAME: ${{ github.event.inputs.server_name }}
          INPUT_CUSTOM_NAME: ${{ github.event.inputs.custom_server_name }}
        run: |
          # ุชุญุฏูุฏ ุงุณู ุงูุณูุฑูุฑ
          if [ "$INPUT_SERVER_NAME" == "Custom (Type Below)" ]; then
            SERVER_NAME="$INPUT_CUSTOM_NAME"
          else
            SERVER_NAME="$INPUT_SERVER_NAME"
          fi
          
          # ุงูุชุฃูุฏ ูู ุนุฏู ูุฑุงุบ ุงูุงุณู
          if [ -z "$SERVER_NAME" ]; then
            echo "โ ุฎุทุฃ: ูู ูุชู ุชุญุฏูุฏ ุงุณู ุงูุณูุฑูุฑ!"
            exit 1
          fi
          
          # ุญูุธ ุงูุงุณู ูู ENV ููุฎุทูุงุช ุงููุงุฏูุฉ
          echo "SERVER_NAME=$SERVER_NAME" >> $GITHUB_ENV
          
          echo "โ๏ธ ุชุญููู ุงูุณูุฑูุฑ ูู Mega..."
          echo "๐ ุงูุณูุฑูุฑ: $SERVER_NAME"
          
          mkdir -p server
          
          # ุชุญููู ุงููุฌูุฏ ูู Mega
          if rclone lsd "mega:minecraft-servers/$SERVER_NAME" 2>/dev/null; then
            echo "โ ุชู ุงูุนุซูุฑ ุนูู ุงูุณูุฑูุฑุ ุฌุงุฑู ุงูุชุญููู..."
            rclone sync "mega:minecraft-servers/$SERVER_NAME" ./server --progress
            echo "โ ุชู ุชุญููู ุงูุณูุฑูุฑ ุจูุฌุงุญ"
          else
            echo "โน๏ธ ุงูุณูุฑูุฑ ุบูุฑ ููุฌูุฏ ุนูู Mega"
            echo "๐ ุณูุชู ุฅูุดุงุก ุณูุฑูุฑ ุฌุฏูุฏ"
          fi
      
      - name: โ๏ธ Parse Configuration (Magic Names)
        id: parse_config
        run: |
          # 1. Default Defaults
          TUNNEL="playit"
          INTERVAL=900
          
          echo "๐ ุชุญููู ุงุณู ุงูุณูุฑูุฑ: $SERVER_NAME"
          
          # 2. Check for ngrok (_ng)
          if [[ "$SERVER_NAME" == *"_ng"* ]]; then
            echo "๐ ุชู ุงูุชุดุงู ุทูุจ ngrok"
            TUNNEL="ngrok"
          fi

          # 3. Check for Cloudflare (_cf)
          if [[ "$SERVER_NAME" == *"_cf"* ]]; then
            echo "โ๏ธ ุชู ุงูุชุดุงู ุทูุจ Cloudflare Tunnel"
            TUNNEL="cloudflare"
          fi
          
          # 4. Check for Custom Interval (_mXX)
          if [[ "$SERVER_NAME" =~ _m([0-9]+) ]]; then
            MINS="${BASH_REMATCH[1]}"
            INTERVAL=$((MINS * 60))
            echo "โฑ๏ธ ุชู ุชุบููุฑ ููุช ุงููุณุฎ ุงูุงุญุชูุงุทู ุฅูู: $MINS ุฏูููุฉ ($INTERVAL ุซุงููุฉ)"
          fi
          
          # Export to Env
          echo "TUNNEL_TYPE=$TUNNEL" >> $GITHUB_ENV
          echo "SYNC_INTERVAL=$INTERVAL" >> $GITHUB_ENV

      - name: Setup Server (if needed)
        run: |
          cd server
          
          echo "๐ ุงูุชุญูู ูู ุญุงูุฉ ุงูุณูุฑูุฑ..."
          
          # ุฅุฐุง ูู ููู ููุงู run.shุ ูุนูู ุงูุณูุฑูุฑ ุฌุฏูุฏ
          if [ ! -f "run.sh" ]; then
            echo "๐ฆ ุณูุฑูุฑ ุฌุฏูุฏ - ุฌุงุฑู ุงูุชุซุจูุช..."
            
            # ูุจูู EULA
            echo "eula=true" > eula.txt
            
            # ุฅูุดุงุก ูุฌูุฏ mods
            mkdir -p mods
            
            # ุฅูุดุงุก server.properties
            cat > server.properties << 'PROPS'
          #Minecraft server properties
          spawn-protection=0
          max-tick-time=60000
          query.port=25565
          generator-settings={}
          sync-chunk-writes=true
          force-gamemode=false
          allow-nether=true
          enforce-whitelist=false
          gamemode=survival
          broadcast-console-to-ops=true
          enable-query=false
          player-idle-timeout=0
          difficulty=easy
          spawn-monsters=true
          broadcast-rcon-to-ops=true
          op-permission-level=4
          pvp=true
          entity-broadcast-range-percentage=100
          level-type=default
          hardcore=false
          enable-status=true
          enable-command-block=false
          max-players=20
          network-compression-threshold=256
          max-world-size=29999984
          server-port=25565
          server-ip=
          spawn-npcs=true
          allow-flight=false
          level-name=world
          view-distance=10
          spawn-animals=true
          white-list=false
          generate-structures=true
          online-mode=false
          max-build-height=256
          motd=Minecraft Server on GitHub Actions
          enable-rcon=false
          PROPS
            
          else
             echo "โ ุชู ุชุญููู ุงูุณูุฑูุฑ ูู Mega!"
             
             # ๐๏ธ ุฅุตูุงุญ ุงููุดุงูู ุงูุดุงุฆุนุฉ ุนูุฏ ุงูุงุณุชุฆูุงู
             echo "๐ง ูุญุต ุงููููุงุช..."
             
             # 1. ุญุฐู ููู ุงูููู
             rm -f world/session.lock
             
             # 2. ุงูุชุฃูุฏ ูู ุตูุงุญูุงุช ููู ุงูุชุดุบูู ูุชุตุญูุญ ุงูุฑุงูุงุช
             # ุงูุจุญุซ ุนู ุจุฏุงุฆู ูู run.sh (ูุฃู ุงูููุฏุจุงูุงุช ุจุชุณููู start.sh ุณุงุนุงุช)
             if [ ! -f "run.sh" ]; then
                for script in start.sh ServerStart.sh LaunchServer.sh run-server.sh; do
                    if [ -f "$script" ]; then
                        echo "โ๏ธ ุชู ุงูุนุซูุฑ ุนูู $script - ุฌุงุฑู ุฅุนุงุฏุฉ ุชุณููุชู ูู run.sh"
                        mv "$script" run.sh
                        break
                    fi
                done
             fi

             if [ -f "run.sh" ]; then
                chmod +x run.sh
                # ุฅุตูุงุญ ุงูุฑุงูุงุช ูู ุงูููู ุฌุงู ูู Mega ุจุฅุนุฏุงุฏุงุช ูุฏููุฉ
                sed -i 's/-Xmx[0-9]*G/-Xmx12G/g' run.sh
                sed -i 's/-Xms[0-9]*G/-Xms12G/g' run.sh
             fi
             
             # 3. ุงูุชุฃูุฏ ูู ููู ุงูุฑุงูุงุช
             echo "-Xmx12G" > user_jvm_args.txt
             echo "-Xms12G" >> user_jvm_args.txt
          fi
          
          # ๐ ุงูุฅุตูุงุญ ุงูุฏููุงูููู ุงูุฐูู (Dynamic Library Repair)
          # ุงููุฏู: ูุนุฑูุฉ ุฅุตุฏุงุฑ Forge ุจุชุงุน ุงูููุฏุจุงู ูุชุซุจูุชู ูู ูู ุจุงูุธุจุท ุนุดุงู ูุตูุญ ุงููููุงุช ุงููุงูุตุฉ
          
          # 1. ุงูุจุญุซ ุนู ูููุฏุฑ Forge ุงููุชุซุจุช
          FORGE_DIR=$(find libraries/net/minecraftforge/forge -maxdepth 1 -type d -name "1.20.1-*" | head -n 1)
          
          if [ -z "$FORGE_DIR" ]; then
             echo "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃู ูููุงุช Forge. ุฌุงุฑู ุชุซุจูุช ุงูุฅุตุฏุงุฑ ุงูุงูุชุฑุงุถู (47.3.0)..."
             FORGE_VERSION="1.20.1-47.3.0"
          else
             # 2. ุงุณุชุฎุฑุงุฌ ุฑูู ุงูุฅุตุฏุงุฑ ูู ุงุณู ุงููููุฏุฑ
             FORGE_VERSION=$(basename "$FORGE_DIR")
             echo "โ ุชู ุงูุชุดุงู ุฅุตุฏุงุฑ Forge ุงููุทููุจ: $FORGE_VERSION"
          fi
          
          # 3. ุชุญููู ูุชุซุจูุช ุงููุณุฎุฉ ุงููุชุทุงุจูุฉ ุชูุงูุงู ูุฅุตูุงุญ ุงูู Libraries
          echo "๐ง ุฌุงุฑู ุชุญููู ูุชุซุจูุช Installer ููุณุฎุฉ: $FORGE_VERSION ..."
          wget -q "https://maven.minecraftforge.net/net/minecraftforge/forge/${FORGE_VERSION}/forge-${FORGE_VERSION}-installer.jar" -O forge-installer.jar
          
          # ุงูุชุซุจูุช
          java -jar forge-installer.jar --installServer
          
          # 4. ุฅุตูุงุญุงุช ูุง ุจุนุฏ ุงูุชุซุจูุช
          if [ -f "run.sh" ]; then
             chmod +x run.sh
             sed -i 's/-Xmx[0-9]*G/-Xmx12G/g' run.sh
             sed -i 's/-Xms[0-9]*G/-Xms12G/g' run.sh
          fi
          
          # ุชุฃููุฏ ุฅุนุฏุงุฏุงุช ุงูุฑุงูุงุช (12GB - Public Runner)
          echo "๐ง ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงูุฑุงูุงุช..."
          echo "-Xmx12G" > user_jvm_args.txt
          echo "-Xms12G" >> user_jvm_args.txt
          
          # ุชุฃููุฏ ูุจูู EULA
          echo "eula=true" > eula.txt
      
      - name: ๐ Setup playit.gg (Default)
        if: env.TUNNEL_TYPE == 'playit'
        run: |
          echo "๐ ุฅุนุฏุงุฏ playit.gg..."
          curl -SsL https://playit-cloud.github.io/ppa/key.gpg | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/playit.gpg >/dev/null
          echo "deb [signed-by=/etc/apt/trusted.gpg.d/playit.gpg] https://playit-cloud.github.io/ppa/data ./" | sudo tee /etc/apt/sources.list.d/playit-cloud.list
          sudo apt update
          sudo apt install playit -y
          echo "โ ุชู ุชุซุจูุช playit.gg"
          
          # Start in background
          cd server
          nohup playit > playit.log 2>&1 &
          echo "โ ุฌุงุฑู ุชุดุบูู playit ูู ุงูุฎูููุฉ"
          
          echo "โณ ุงูุชุธุงุฑ ุฑุงุจุท ุงูุชูุนูู (10 ุซูุงูู)..."
          sleep 10
          
          echo "========================================="
          echo "๐ ุฑุงุจุท ุชูุนูู playit.gg:"
          grep -o 'https://playit.gg/claim/.*' playit.log || cat playit.log
          echo "========================================="

      - name: ๐ Setup ngrok (Optional)
        if: env.TUNNEL_TYPE == 'ngrok'
        run: |
          cd server
          echo "๐ฅ ุชูุฒูู ngrok..."
          wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
          tar -xzf ngrok-v3-stable-linux-amd64.tgz
          chmod +x ngrok
          
          echo "๐ ุชูุนูู ุงูุชููู..."
          # Hardcoded Token as requested
          ./ngrok config add-authtoken 35AOdKAlenxQzvzq8HLpuExYQBL_2wxtVfzEK9r4vcBBUwkTj
          
          echo "๐ ุชุดุบูู ุงูุชุงูู..."
          nohup ./ngrok tcp 25565 --log=stdout > ngrok.log 2>&1 &
          
          sleep 5
          echo "========================================="
          echo "๐ ุฑุงุจุท ุงูุณูุฑูุฑ (ngrok):"
          curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url' || echo "Error getting url"
          echo "========================================="
      
      - name: โ๏ธ Setup Cloudflare Tunnel (Optional)
        if: env.TUNNEL_TYPE == 'cloudflare'
        run: |
          cd server
          echo "๐ฅ ุชูุฒูู Cloudflare Tunnel..."
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -O cloudflared
          chmod +x cloudflared
          
          echo "๐ ุชุดุบูู ุงูุชุงูู..."
          # ุญุฐู ุงูุณุฌู ุงููุฏูู ูุชุฌูุจ ุงูุชุฏุงุฎู
          rm -f cloudflare.log
          
          # Start Quick Tunnel
          nohup ./cloudflared tunnel --url tcp://localhost:25565 --logfile cloudflare.log > /dev/null 2>&1 &
          
          echo "โณ ุงูุชุธุงุฑ ุฑุงุจุท Cloudflare (20 ุซุงููุฉ)..."
          sleep 20
          
          echo "========================================="
          echo "๐ ุฑุงุจุท ุงูุณูุฑูุฑ (Cloudflare):"
          
          # ุงุณุชุฎุฑุงุฌ ุงูุฑุงุจุท ุจุดูู ุฏููู (ุชุฌุงูู ุงูุฑููุฒ ุงูุบุฑูุจุฉ)
          URL=$(grep -o 'https://[-a-zA-Z0-9]*\.trycloudflare\.com' cloudflare.log | head -n 1)
          
          if [ -z "$URL" ]; then
             echo "โ๏ธ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุฑุงุจุท ุชููุงุฆูุงู. ุนุฑุถ ุงูุณุฌู ูุงูู:"
             cat cloudflare.log
          else
             echo "$URL"
          fi
          echo "========================================="

      - name: Run Server with Auto-Sync
        run: |
          cd server
          
          echo "๐ ุจุฏุก ุงูุณูุฑูุฑ..."
          echo "======================================"
          echo "๐ ุงูุณูุฑูุฑ: $SERVER_NAME"
          echo "โฐ ููุช ุงูุจุฏุก: $(date)"
          echo "๐ Sync ูู 15 ุฏูููุฉ"
          echo "======================================"
          
          # ุงูุชุงูู ูุนูู ูู ุงูุฎูููุฉ ุจุงููุนู (ูู ุงูุฎุทูุฉ ุงูุณุงุจูุฉ)
          echo "โ ุงูุชุฃูุฏ ูู ุนูู ุงูุชุงูู..."
          
          echo ""
          echo "๐ ููุญุตูู ุนูู IP:"
          echo "https://playit.gg/account/agents"
          echo "======================================"
          
          # ุฏุงูุฉ Sync ูุน Mega
          sync_to_mega() {
            echo "๐พ ูุฒุงููุฉ ูุน Mega... $(date)"
            
            # ุฅูุดุงุก ูุฌูุฏ mods ูู ูุด ููุฌูุฏ
            mkdir -p mods
            touch mods/.gitkeep
            
            rclone sync . "mega:minecraft-servers/$SERVER_NAME" \
              --exclude="libraries/**" \
              --exclude="logs/**" \
              --exclude="crash-reports/**" \
              --exclude="*.jar.cache" \
              --exclude="forge-installer.jar" \
              --progress
            echo "โ ุชู ุงูุญูุธ"
          }
          
          # ุชุดุบูู ุงูุณูุฑูุฑ
          if [ -f "run.sh" ]; then
            bash run.sh --nogui &
            SERVER_PID=$!
          else
            echo "โ ูู ูุชู ุงูุนุซูุฑ ุนูู run.sh"
            exit 1
          fi
          
          echo "โณ ุงูุชุธุงุฑ ุจุฏุก ุงูุณูุฑูุฑ..."
          sleep 120
          
          # ุฃูู sync
          sync_to_mega
          
          # Sync Interval comes from ENV now
          echo "๐ ูุธุงู ุงููุณุฎ ุงูุงุญุชูุงุทู ูุนูู ูู $SYNC_INTERVAL ุซุงููุฉ"
          ELAPSED=0
          
          while kill -0 $SERVER_PID 2>/dev/null; do
            sleep 60
            ELAPSED=$((ELAPSED + 60))
            
            # ุงุณุชุฎุฏุงู Modulo ููููุช
            if [ $((ELAPSED % SYNC_INTERVAL)) -eq 0 ]; then
                sync_to_mega
              fi
            done
            
            # ูู ุงูููุจ ุฎูุตุ ูุจูู ุงูุณูุฑูุฑ ููู
            echo "โ ุงูุณูุฑูุฑ ุชููู ุนู ุงูุนูู!"
            if [ -f "logs/latest.log" ]; then
              echo "๐ ุนุฑุถ ุขุฎุฑ Log:"
              echo "==================================================="
              tail -n 100 logs/latest.log
              echo "==================================================="
            fi
            
            # ุญูุธ ุฃุฎูุฑ
            sync_to_mega
          
          echo "======================================"
          echo "โฐ ููุช ุงูุฅููุงู: $(date)"
          echo "โ ุชู ุญูุธ ูู ุดูุก"
          echo "======================================"
